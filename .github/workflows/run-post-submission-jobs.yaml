# This workflow is designed to run shortly after the hub's weekly submission
# deadline. It generates an unscored-location-dates file as well as time
# series and oracle output target data.
name: Run post-submission jobs

on:
  schedule:
    # Not precise, but GithHub actions don't support time zones
    - cron: "20 01 * 11-12,1-3 4" # 1:20 AM UTC every Thurs (Nov-Dec, Jan-Mar)
    - cron: "20 00 * 4-10 4" # 12:20 AM UTC every Thurs (Apr-Oct)
  workflow_dispatch:
    inputs:
      nowcast_date:
        description: "Nowcast date (YYYY-MM-DD)"
        required: false

permissions:
    contents: write
    pull-requests: write

jobs:

  get-all-dates:
    runs-on: ubuntu-latest
    outputs:
      NOWCAST_DATE: ${{ steps.set-dates.outputs.NOWCAST_DATE }}
      TARGET_NOWCAST_DATE: ${{ steps.set-dates.outputs.TARGET_NOWCAST_DATE }}
      SEQUENCE_AS_OF: ${{ steps.set-dates.outputs.SEQUENCE_AS_OF }}
      matrix: ${{ steps.set-dates.outputs.MATRIX_DATES }}
    steps:
      - name: Checkout ðŸ›Žï¸
        uses: actions/checkout@v4
        with:
            # only checkout what we need
            sparse-checkout: |
              .github/

      - name: Set dates ðŸ•°ï¸
        id: set-dates
        # Nowcast_date = round_id of the round that just closed for submissions.
        # Target_nowcast_date = round_id of the round the can now be officially
        # closed and scored (i.e., 91 days before current round).continue-on-error: 
        # Sequence_as_of = date used to get the sequences for clade assignment.
        # Matrix_dates = dates used for matrix in create-target-data job.
        run: |
          set -x
          source ${GITHUB_WORKSPACE}/.github/shared/shared-functions.sh
          NOWCAST_DATE=$(get_latest_wednesday "${{ inputs.nowcast_date }}")
          TARGET_NOWCAST_DATE=$(date -d "$NOWCAST_DATE - 91 days" +%Y-%m-%d)
          SEQUENCE_AS_OF=$(date -d "$NOWCAST_DATE - 1 day" +%Y-%m-%d)
          MATRIX_DATES=$(generate_weekly_dates "$NOWCAST_DATE" 1)
          echo "NOWCAST_DATE=$NOWCAST_DATE" >> $GITHUB_OUTPUT
          echo "TARGET_NOWCAST_DATE=$TARGET_NOWCAST_DATE" >> $GITHUB_OUTPUT
          echo "SEQUENCE_AS_OF=$SEQUENCE_AS_OF" >> $GITHUB_OUTPUT
          echo "MATRIX_DATES=$MATRIX_DATES" >> $GITHUB_OUTPUT
          echo "Submissions closed job for $NOWCAST_DATE"
          echo "Starting date for target files is $TARGET_NOWCAST_DATE"
          echo "Sequence as of date is $SEQUENCE_AS_OF"
          echo "Matrix dates are $MATRIX_DATES"

      # next step: based on the target nowcast date, get the remainder of
      # the dates to populate the matrix for the create-target-data job

  # Create target data for the round that closed 90 days ago.
  # This step will exit if there is no round with a nowcast
  # date 90 days ago.
  create-target-data:
    runs-on: ubuntu-latest
    needs: get-all-dates
    env:
      SEQUENCE_AS_OF: ${{ needs.get-all-dates.outputs.SEQUENCE_AS_OF }}
    strategy:
      matrix: ${{ fromJson(needs.get-all-dates.outputs.matrix) }}
    steps:
      - name: Checkout ðŸ›Žï¸
        uses: actions/checkout@v4
        with:
            # only checkout what we need
            sparse-checkout: |
              .github/
              auxiliary-data/
              hub-config/
              target-data/
              src/

      - name: Install uv ðŸ
        uses: astral-sh/setup-uv@v5
        with:
          version: ">=0.0.1"

      # REMOVE collection_min_date, it's there for running faster tests
      - name: Create target data ðŸŽ¯
        run: |
          echo "sequence_as_of: $SEQUENCE_AS_OF"
          uv run get_target_data.py \
          --nowcast-date=${{ matrix.nowcast-date }} \
          --sequence-as-of=${{ env.SEQUENCE_AS_OF }} \
          --target-data-dir=${{ github.workspace }} \
          --collection-min-date=2025-01-15
        working-directory: src

      - name: Upload target data ðŸ“¤
        uses: actions/upload-artifact@v4
        with:
          name: target-data-${{ matrix.nowcast-date }}
          path: |
            ${{ github.workspace }}/time-series/**/**/*.parquet
            ${{ github.workspace }}/oracle-output/**/*.parquet

  target-data-pr:
    runs-on: ubuntu-latest
    needs: create-target-data

    steps:
      - name: Download target data ðŸ“¥
        uses: actions/download-artifact@v4
        with:
          pattern: target-data-*
          path: ${{ github.workspace }}

      - name: debug1
        run: |
          ls -l ${{ github.workspace }}

      - name: Move target and interim data to hub directory âž¡ï¸
        run: |
          mv ${{ github.workspace }}/time-series ${{ github.workspace }}/target-data/
          mv ${{ github.workspace }}/oracle-output ${{ github.workspace }}/target-data/

      - name: debug2
        run: |
          ls -l target-data/

      - name: Create PR for new target and interim data
        uses: ./.github/actions/create-pr
        with:
          pr-prefix: "add-target-data"
          file-path: target-data/
          commit-message: "Add target data and interim files."
          pr-body: "Created via GitHub Actions: generate target and interim data."

  # create-location-date-sequence-counts:
  #   runs-on: ubuntu-latest
  #   steps:
  #     - name: Checkout ðŸ›Žï¸
  #       uses: actions/checkout@v4
  #       with:
  #           # only checkout what we need
  #           sparse-checkout: |
  #             .github/
  #             auxiliary-data/
  #             hub-config/
  #             src/

  #     - name: Install uv ðŸ
  #       uses: astral-sh/setup-uv@v5
  #       with:
  #         version: ">=0.0.1"

  #     - name: Get nowcast date (aka round_id) ðŸ•°ï¸
  #       # if nowcast_date is not provided, use the most recent Wednesday
  #       run: |
  #         source ${GITHUB_WORKSPACE}/.github/shared/shared-functions.sh
  #         NOWCAST_DATE=$(get_latest_wednesday "${{ inputs.nowcast_date }}")
  #         echo "NOWCAST_DATE=$NOWCAST_DATE" >> $GITHUB_ENV
  #         echo "Nowcast date for most recent round: $NOWCAST_DATE"

  #     - name: Create file of sequence counts by location and date ðŸ¦ 
  #       run: |
  #         uv run get_location_date_counts.py --nowcast-date=$NOWCAST_DATE
  #       working-directory: src

  #     - name: Create PR for sequence counts ðŸš€
  #       uses: ./.github/actions/create-pr
  #       with:
  #         pr-prefix: "${{ env.NOWCAST_DATE }}-unscored-locations"
  #         file-path: auxiliary-data/unscored-location-dates/
  #         commit-message: "Add unscored locations for round $NOWCAST_DATE"
  #         pr-body: "Created via GitHub Actions: generate count of sequences collected by date/location for the past 31 days."
